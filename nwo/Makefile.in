
PROGS = hmmer

OBJS   = \
	general.o      \
	h4_build.o     \
	h4_cmd_build.o \
	h4_path.o      \
	h4_prior.o     \
	h4_profile.o   \
	modelio.o      \
	parameterize.o

UTESTS = \
	h4_path_utest

STATS  =

EXPERIMENTS = \
	h4_build_experiment  \
	h4_build_experiment2

BENCHMARKS =

EXAMPLES = 



SSE4_OBJS   =
AVX_OBJS    = 
AVX512_OBJS =
NEON_OBJS   =
VMX_OBJS    = 

HDRS = \
	h4_config.h   \
	general.h     \
	h4_build.h    \
	h4_path.h     \
	h4_prior.h    \
	h4_profile.h  \
	modelio.h     \
	parameterize.h

top_srcdir     = @top_srcdir@
top_builddir   = @top_builddir@
srcdir         = @srcdir@
VPATH          = @srcdir@ 
SHELL          = /bin/sh

prefix         = @prefix@
exec_prefix    = @exec_prefix@
datarootdir    = @datarootdir@
bindir         = @bindir@
libdir         = @libdir@
includedir     = @includedir@

CC             = @CC@
CFLAGS         = @CFLAGS@ 
PTHREAD_CFLAGS = @PTHREAD_CFLAGS@
SSE4_CFLAGS    = @SSE4_CFLAGS@
AVX_CFLAGS     = @AVX_CFLAGS@
AVX512_CFLAGS  = @AVX512_CFLAGS@
NEON_CFLAGS    = @NEON_CFLAGS@
VMX_CFLAGS     = @VMX_CFLAGS@
CPPFLAGS       = @CPPFLAGS@
LDFLAGS        = @LDFLAGS@
DEFS           = @DEFS@
LIBS           = -lhmmer -leasel -ldivsufsort @MPILIBS@ @LIBS@ -lm

AR             = @AR@ 
RANLIB         = @RANLIB@
INSTALL        = @INSTALL@

# in MYINCDIRs, we have build dirs first, because headers generated by
# ./configure (p7_config.h, esl_config.h) are in build dirs, not
# source dirs; and we want to find these first (in case an errant one is
# in the source tree). All other headers are in the source tree.
# 
ESLDIR       = @HMMER_ESLDIR@
SADIR        = @HMMER_SADIR@
MYLIBDIRS    = -L${top_builddir}/${ESLDIR}\
               -L${top_builddir}/${SADIR}\
               ${LIBTMPDIR} \
               -L${top_builddir}/nwo
MYINCDIRS    = -I${top_builddir}/${ESLDIR} \
               -I${top_builddir}/${SADIR} \
	       -I${top_builddir}/nwo \
	       -I${top_srcdir}/${ESLDIR} \
	       -I${top_srcdir}/${SADIR} \
	       -I${top_srcdir}/nwo
MYLIBDEPS    = ${LIBTMPDEP} ${top_builddir}/nwo/libhmmer.a ${top_builddir}/${ESLDIR}/libeasel.a ${top_builddir}/${SADIR}/libdivsufsort.a



# beautification magic stolen from git 
QUIET_SUBDIR0 = +${MAKE} -C #space separator after -c
QUIET_SUBDIR1 = 
ifndef V
	QUIET_CC      = @echo '    ' CC $@;
	QUIET_GEN     = @echo '    ' GEN $@;
	QUIET_AR      = @echo '    ' AR $@;
	QUIET_SUBDIR0 = +@subdir=
	QUIET_SUBDIR1 = ; echo '    ' SUBDIR $$subdir; \
		        ${MAKE} -C $$subdir
	QUIET         = @
endif

ALL_OBJS        = ${OBJS}       ${SSE_OBJS}       ${AVX_OBJS}       ${AVX512_OBJS}       ${NEON_OBJS}       ${VMX_OBJS}
ALL_UTESTS      = ${UTESTS}     ${SSE_UTESTS}     ${AVX_UTESTS}     ${AVX512_UTESTS}     ${NEON_UTESTS}     ${VMX_UTESTS}
ALL_EXPERIMENTS = ${EXPERIMENTS}
ALL_STATS       = ${STATS}      ${SSE_STATS}      ${AVX_STATS}      ${AVX512_STATS}      ${NEON_STATS}      ${VMX_STATS}
ALL_BENCHMARKS  = ${BENCHMARKS} ${SSE_BENCHMARKS} ${AVX_BENCHMARKS} ${AVX512_BENCHMARKS} ${NEON_BENCHMARKS} ${VMX_BENCHMARKS}
ALL_EXAMPLES    = ${EXAMPLES}   ${SSE_EXAMPLES}   ${AVX_EXAMPLES}   ${AVX512_EXAMPLES}   ${NEON_EXAMPLES}   ${VMX_EXAMPLES}


${SSE_OBJS}:          SIMD_CFLAGS:= $(SSE4_CFLAGS)     
${AVX_OBJS}:          SIMD_CFLAGS:= $(AVX_CFLAGS)     
${AVX512_OBJS}:       SIMD_CFLAGS:= $(AVX512_CFLAGS)  
${NEON_OBJS}:         SIMD_CFLAGS:= $(NEON_CFLAGS)    
${VMX_OBJS}:          SIMD_CFLAGS:= $(VMX_CFLAGS)     

${SSE_UTESTS}:        SIMD_CFLAGS:= $(SSE4_CFLAGS)     
${AVX_UTESTS}:        SIMD_CFLAGS:= $(AVX_CFLAGS)     
${AVX512_UTESTS}:     SIMD_CFLAGS:= $(AVX512_CFLAGS)  
${NEON_UTESTS}:       SIMD_CFLAGS:= $(NEON_CFLAGS)    
${VMX_UTESTS}:        SIMD_CFLAGS:= $(VMX_CFLAGS)     

${SSE_STATS}:         SIMD_CFLAGS:= $(SSE4_CFLAGS)     
${AVX_STATS}:         SIMD_CFLAGS:= $(AVX_CFLAGS)     
${AVX512_STATS}:      SIMD_CFLAGS:= $(AVX512_CFLAGS)  
${NEON_STATS}:        SIMD_CFLAGS:= $(NEON_CFLAGS)    
${VMX_STATS}:         SIMD_CFLAGS:= $(VMX_CFLAGS)     

${SSE_BENCHMARKS}:    SIMD_CFLAGS:= $(SSE4_CFLAGS)     
${AVX_BENCHMARKS}:    SIMD_CFLAGS:= $(AVX_CFLAGS)     
${AVX512_BENCHMARKS}: SIMD_CFLAGS:= $(AVX512_CFLAGS)  
${NEON_BENCHMARKS}:   SIMD_CFLAGS:= $(NEON_CFLAGS)    
${VMX_BENCHMARKS}:    SIMD_CFLAGS:= $(VMX_CFLAGS)     

${SSE_EXAMPLES}:      SIMD_CFLAGS:= $(SSE4_CFLAGS)     
${AVX_EXAMPLES}:      SIMD_CFLAGS:= $(AVX_CFLAGS)     
${AVX512_EXAMPLES}:   SIMD_CFLAGS:= $(AVX512_CFLAGS)  
${NEON_EXAMPLES}:     SIMD_CFLAGS:= $(NEON_CFLAGS)    
${VMX_EXAMPLES}:      SIMD_CFLAGS:= $(VMX_CFLAGS)     

.PHONY: all dev check tests install uninstall distclean clean tags-append
.FORCE:

all:    ${PROGS} 
check:  ${PROGS} ${UTESTS}
dev:    ${PROGS} ${UTESTS} ${EXPERIMENTS} ${STATS} ${BENCHMARKS} ${EXAMPLES}

# Programs build from their .c's directly. They are not included in libhmmer.a.
${PROGS}: % : %.c  libhmmer.a ${HDRS}
	${QUIET_GEN}${CC} ${CFLAGS} ${SIMD_CFLAGS} ${PTHREAD_CFLAGS} ${CPPFLAGS} ${DEFS} ${MYINCDIRS} ${LDFLAGS} ${MYLIBDIRS} -o $@ $< ${LIBS}

# All other object code is included in libhmmer.a.
libhmmer.a: ${ALL_OBJS}
	${QUIET_AR}${AR} -r libhmmer.a $? > /dev/null 2>&1 
	@${RANLIB} libhmmer.a

${ALL_OBJS}:  %.o : %.c ${HDRS} 
	${QUIET_CC}${CC} ${CFLAGS} ${SIMD_CFLAGS} ${PTHREAD_CFLAGS} ${CPPFLAGS} ${DEFS} ${MYINCDIRS} -c $<

${ALL_UTESTS}: libhmmer.a ${HDRS} h4_config.h
	@BASENAME=`echo $@ | sed -e 's/_utest//' | sed -e 's/^h4_//'` ;\
	DFLAG=`echo $${BASENAME} | sed -e 'y/abcdefghijklmnopqrstuvwxyz/ABCDEFGHIJKLMNOPQRSTUVWXYZ/'`;\
	DFLAG=h4$${DFLAG}_TESTDRIVE ;\
	if test -e ${srcdir}/h4_$${BASENAME}.c; then \
           DFILE=${srcdir}/h4_$${BASENAME}.c ;\
        else \
           DFILE=${srcdir}/$${BASENAME}.c ;\
	fi;\
	if test ${V} ;\
	   then echo "${CC} ${CFLAGS} ${SIMD_CFLAGS} ${PTHREAD_CFLAGS} ${CPPFLAGS} ${DEFS} ${MYINCDIRS} ${LDFLAGS} ${MYLIBDIRS} -D$${DFLAG} -o $@ $${DFILE} ${LIBS}" ;\
	   else echo '    ' GEN $@ ;\
        fi ;\
	${CC} ${CFLAGS} ${SIMD_CFLAGS} ${PTHREAD_CFLAGS} ${CPPFLAGS} ${DEFS} ${MYINCDIRS} ${LDFLAGS} ${MYLIBDIRS} -D$${DFLAG} -o $@ $${DFILE} ${LIBS}

${ALL_EXPERIMENTS}: libhmmer.a ${HDRS} h4_config.h
	@BASENAME=`echo $@ | sed -e 's/_experiment[0-9]*//' | sed -e 's/^h4_//'` ;\
	DFLAG=h4`echo $@ | sed -e 's/^h4_//' | sed -e 'y/abcdefghijklmnopqrstuvwxyz/ABCDEFGHIJKLMNOPQRSTUVWXYZ/'`;\
	if test -e ${srcdir}/h4_$${BASENAME}.c    ;\
	   then DFILE=${srcdir}/h4_$${BASENAME}.c ;\
	   else DFILE=${srcdir}/$${BASENAME}.c    ;\
	fi;\
	if test ${V} ;\
	   then echo "${CC} ${CFLAGS} ${SIMD_CFLAGS} ${PTHREAD_CFLAGS} ${CPPFLAGS} ${DEFS} ${MYINCDIRS} ${LDFLAGS} ${MYLIBDIRS} -D$${DFLAG} -o $@ $${DFILE} ${LIBS}" ;\
	   else echo '    ' GEN $@ ;\
        fi ;\
	${CC} ${CFLAGS} ${SIMD_CFLAGS} ${PTHREAD_CFLAGS} ${CPPFLAGS} ${DEFS} ${MYINCDIRS} ${LDFLAGS} ${MYLIBDIRS} -D$${DFLAG} -o $@ $${DFILE} ${LIBS}

distclean: clean
	-rm -f Makefile h4_config.h

clean:
	-rm -f ${PROGS} ${UTESTS} ${STATS} ${BENCHMARKS} ${EXAMPLES} ${EXPERIMENTS} libhmmer.a
	-rm -f *~ *.o 
	-rm -f *.gcno *.gcda *.gcov
	for prog in ${PROGS} ${UTESTS} ${STATS} ${BENCHMARKS} ${EXAMPLES} ${EXPERIMENTS}; do\
	  if test -d $$prog.dSYM; then rm -rf $$prog.dSYM; fi; \
	done
