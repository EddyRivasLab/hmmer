PROGS = hmmer

OBJS   = \
	cmd_build.o         \
	h4_counts.o         \
	h4_filtermx.o       \
	h4_hmmfile.o        \
	h4_mode.o           \
	h4_path.o           \
	h4_prior.o          \
	h4_profile.o        \
	h4_refmx.o          \
	build.o             \
	emit.o              \
	eweight.o           \
	general.o           \
	logsum.o            \
	modelsample.o       \
	modelstats.o        \
	parameterize.o      \
	reference_dp.o      \
	simdvec.o           \
	ssvfilter.o         \
	standardize.o       \
	vectorize.o         \
	vitfilter.o         \
	zigar.o

SSE4_OBJS   = ssvfilter_sse.o    vitfilter_sse.o
AVX_OBJS    = ssvfilter_avx.o    vitfilter_avx.o
AVX512_OBJS = ssvfilter_avx512.o vitfilter_avx512.o
NEON_OBJS   = ssvfilter_neon.o   vitfilter_neon.o
VMX_OBJS    = ssvfilter_vmx.o    vitfilter_vmx.o

HDRS = \
	h4_config.h         \
	cmd_build.h         \
	h4_counts.h         \
	h4_filtermx.h       \
	h4_hmmfile.h        \
	h4_mode.h           \
	h4_path.h           \
	h4_prior.h          \
	h4_profile.h        \
	h4_refmx.h          \
	build.h             \
	emit.h              \
	eweight.h           \
	general.h           \
	logsum.h            \
	modelsample.h       \
	modelstats.h        \
	parameterize.h      \
	reference_dp.h      \
	simdvec.h           \
	ssvfilter.h         \
	standardize.h       \
	vectorize.h         \
	vitfilter.h         \
	zigar.h


UTESTS = \
	h4_hmmfile_utest   \
	h4_mode_utest      \
	h4_path_utest      \
	h4_profile_utest   \
	logsum_utest       \
	modelsample_utest  \
	reference_dp_utest \
	ssvfilter_utest    \
	vitfilter_utest    \
	zigar_utest

STATS  =

EXPERIMENTS = \
	h4_build_experiment  \
	h4_build_experiment2

BENCHMARKS = \
	logsum_benchmark        \
	reference_dp_benchmark  \
	ssvfilter_benchmark     \
	vitfilter_benchmark     \

EXAMPLES = \
	h4_hmmfile_example        \
	h4_path_example           \
	emit_example              \
	logsum_example            \
	reference_dp_example      \
	ssvfilter_example         \
	vitfilter_example         \
	zigar_example




top_srcdir     = @top_srcdir@
top_builddir   = @top_builddir@
srcdir         = @srcdir@
VPATH          = @srcdir@
SHELL          = /bin/sh

prefix         = @prefix@
exec_prefix    = @exec_prefix@
datarootdir    = @datarootdir@
bindir         = @bindir@
libdir         = @libdir@
includedir     = @includedir@

CC             = @CC@
CFLAGS         = @CFLAGS@
PTHREAD_CFLAGS = @PTHREAD_CFLAGS@
SSE4_CFLAGS    = @SSE4_CFLAGS@
AVX_CFLAGS     = @AVX_CFLAGS@
AVX512_CFLAGS  = @AVX512_CFLAGS@
NEON_CFLAGS    = @NEON_CFLAGS@
VMX_CFLAGS     = @VMX_CFLAGS@
CPPFLAGS       = @CPPFLAGS@
LDFLAGS        = @LDFLAGS@
DEFS           = @DEFS@
LIBS           = -lhmmer -leasel -ldivsufsort @MPILIBS@ @LIBS@ -lm

AR             = @AR@
RANLIB         = @RANLIB@
INSTALL        = @INSTALL@

# in MYINCDIRs, we have build dirs first, because headers generated by
# ./configure (p7_config.h, esl_config.h) are in build dirs, not
# source dirs; and we want to find these first (in case an errant one is
# in the source tree). All other headers are in the source tree.
#
ESLDIR       = @HMMER_ESLDIR@
SADIR        = @HMMER_SADIR@
MYLIBDIRS    = -L${top_builddir}/${ESLDIR}\
               -L${top_builddir}/${SADIR}\
               ${LIBTMPDIR} \
               -L${top_builddir}/nwo
MYINCDIRS    = -I${top_builddir}/${ESLDIR} \
               -I${top_builddir}/${SADIR} \
	       -I${top_builddir}/nwo \
	       -I${top_srcdir}/${ESLDIR} \
	       -I${top_srcdir}/${SADIR} \
	       -I${top_srcdir}/nwo
MYLIBDEPS    = ${LIBTMPDEP} ${top_builddir}/nwo/libhmmer.a ${top_builddir}/${ESLDIR}/libeasel.a ${top_builddir}/${SADIR}/libdivsufsort.a



# beautification magic stolen from git 
QUIET_SUBDIR0 = +${MAKE} -C #space separator after -c
QUIET_SUBDIR1 = 
ifndef V
	QUIET_CC      = @echo '    ' CC $@;
	QUIET_GEN     = @echo '    ' GEN $@;
	QUIET_AR      = @echo '    ' AR $@;
	QUIET_SUBDIR0 = +@subdir=
	QUIET_SUBDIR1 = ; echo '    ' SUBDIR $$subdir; \
		        ${MAKE} -C $$subdir
	QUIET         = @
endif

ALL_OBJS        = ${OBJS}       ${SSE4_OBJS}       ${AVX_OBJS}       ${AVX512_OBJS}       ${NEON_OBJS}       ${VMX_OBJS}
ALL_UTESTS      = ${UTESTS}     ${SSE4_UTESTS}     ${AVX_UTESTS}     ${AVX512_UTESTS}     ${NEON_UTESTS}     ${VMX_UTESTS}
ALL_EXPERIMENTS = ${EXPERIMENTS}
ALL_STATS       = ${STATS}      ${SSE4_STATS}      ${AVX_STATS}      ${AVX512_STATS}      ${NEON_STATS}      ${VMX_STATS}
ALL_BENCHMARKS  = ${BENCHMARKS} ${SSE4_BENCHMARKS} ${AVX_BENCHMARKS} ${AVX512_BENCHMARKS} ${NEON_BENCHMARKS} ${VMX_BENCHMARKS}
ALL_EXAMPLES    = ${EXAMPLES}   ${SSE4_EXAMPLES}   ${AVX_EXAMPLES}   ${AVX512_EXAMPLES}   ${NEON_EXAMPLES}   ${VMX_EXAMPLES}


${SSE4_OBJS}:         SIMD_CFLAGS:= $(SSE4_CFLAGS)     
${AVX_OBJS}:          SIMD_CFLAGS:= $(AVX_CFLAGS)     
${AVX512_OBJS}:       SIMD_CFLAGS:= $(AVX512_CFLAGS)  
${NEON_OBJS}:         SIMD_CFLAGS:= $(NEON_CFLAGS)    
${VMX_OBJS}:          SIMD_CFLAGS:= $(VMX_CFLAGS)     

${SSE4_UTESTS}:       SIMD_CFLAGS:= $(SSE4_CFLAGS)     
${AVX_UTESTS}:        SIMD_CFLAGS:= $(AVX_CFLAGS)     
${AVX512_UTESTS}:     SIMD_CFLAGS:= $(AVX512_CFLAGS)  
${NEON_UTESTS}:       SIMD_CFLAGS:= $(NEON_CFLAGS)    
${VMX_UTESTS}:        SIMD_CFLAGS:= $(VMX_CFLAGS)     

${SSE4_STATS}:        SIMD_CFLAGS:= $(SSE4_CFLAGS)     
${AVX_STATS}:         SIMD_CFLAGS:= $(AVX_CFLAGS)     
${AVX512_STATS}:      SIMD_CFLAGS:= $(AVX512_CFLAGS)  
${NEON_STATS}:        SIMD_CFLAGS:= $(NEON_CFLAGS)    
${VMX_STATS}:         SIMD_CFLAGS:= $(VMX_CFLAGS)     

${SSE4_BENCHMARKS}:   SIMD_CFLAGS:= $(SSE4_CFLAGS)     
${AVX_BENCHMARKS}:    SIMD_CFLAGS:= $(AVX_CFLAGS)     
${AVX512_BENCHMARKS}: SIMD_CFLAGS:= $(AVX512_CFLAGS)  
${NEON_BENCHMARKS}:   SIMD_CFLAGS:= $(NEON_CFLAGS)    
${VMX_BENCHMARKS}:    SIMD_CFLAGS:= $(VMX_CFLAGS)     

${SSE4_EXAMPLES}:     SIMD_CFLAGS:= $(SSE4_CFLAGS)     
${AVX_EXAMPLES}:      SIMD_CFLAGS:= $(AVX_CFLAGS)     
${AVX512_EXAMPLES}:   SIMD_CFLAGS:= $(AVX512_CFLAGS)  
${NEON_EXAMPLES}:     SIMD_CFLAGS:= $(NEON_CFLAGS)    
${VMX_EXAMPLES}:      SIMD_CFLAGS:= $(VMX_CFLAGS)     

.PHONY: all dev check tests install uninstall distclean clean tags-append
.FORCE:

all:    ${PROGS} 
dev:    ${PROGS} ${UTESTS} ${EXPERIMENTS} ${STATS} ${BENCHMARKS} ${EXAMPLES}

check:  ${PROGS} ${UTESTS}
	@command -v python3 >/dev/null 2>&1 || { echo >&2 "python3 is required for 'make check', but is not in your PATH. Aborting."; exit 1; }
	@echo 
	@echo Running HMMER NWO test suite...
	@echo
	@${top_srcdir}/lib/easel/devkit/sqc 1 nwo_tests.sqc .. ${srcdir}/..


# Programs build from their .c's directly. They are not included in libhmmer.a.
${PROGS}: % : %.c  libhmmer.a ${HDRS}
	${QUIET_GEN}${CC} ${CFLAGS} ${SIMD_CFLAGS} ${PTHREAD_CFLAGS} ${CPPFLAGS} ${DEFS} ${MYINCDIRS} ${LDFLAGS} ${MYLIBDIRS} -o $@ $< ${LIBS}

# All other object code is included in libhmmer.a.
libhmmer.a: ${ALL_OBJS}
	${QUIET_AR}${AR} -r libhmmer.a $? > /dev/null 2>&1 
	@${RANLIB} libhmmer.a

${ALL_OBJS}:  %.o : %.c ${HDRS} 
	${QUIET_CC}${CC} ${CFLAGS} ${SIMD_CFLAGS} ${PTHREAD_CFLAGS} ${CPPFLAGS} ${DEFS} ${MYINCDIRS} -c $<

${ALL_EXAMPLES}: libhmmer.a ${top_builddir}/lib/easel/libeasel.a ${HDRS} h4_config.h
	@BASENAME=`echo $@ | sed -e 's/_example[0-9]*//' | sed -e 's/^h4_//'` ;\
	DFLAG=h4`echo $@ | sed -e 's/^h4_//' | sed -e 'y/abcdefghijklmnopqrstuvwxyz/ABCDEFGHIJKLMNOPQRSTUVWXYZ/'`;\
	if test -e ${srcdir}/h4_$${BASENAME}.c    ;\
	   then DFILE=${srcdir}/h4_$${BASENAME}.c ;\
	   else DFILE=${srcdir}/$${BASENAME}.c    ;\
	fi;\
	if test ${V} ;\
	   then echo "${CC} ${CFLAGS} ${SIMD_CFLAGS} ${PTHREAD_CFLAGS} ${CPPFLAGS} ${DEFS} ${MYINCDIRS} ${LDFLAGS} ${MYLIBDIRS} -D$${DFLAG} -o $@ $${DFILE} ${LIBS}" ;\
	   else echo '    ' GEN $@ ;\
        fi ;\
	${CC} ${CFLAGS} ${SIMD_CFLAGS} ${PTHREAD_CFLAGS} ${CPPFLAGS} ${DEFS} ${MYINCDIRS} ${LDFLAGS} ${MYLIBDIRS} -D$${DFLAG} -o $@ $${DFILE} ${LIBS}

${ALL_BENCHMARKS}: libhmmer.a ${top_builddir}/lib/easel/libeasel.a ${HDRS} h4_config.h
	@BASENAME=`echo $@ | sed -e 's/_benchmark[0-9]*//' | sed -e 's/^h4_//'` ;\
	DFLAG=h4`echo $@ | sed -e 's/^h4_//' | sed -e 'y/abcdefghijklmnopqrstuvwxyz/ABCDEFGHIJKLMNOPQRSTUVWXYZ/'`;\
	if test -e ${srcdir}/h4_$${BASENAME}.c    ;\
	   then DFILE=${srcdir}/h4_$${BASENAME}.c ;\
	   else DFILE=${srcdir}/$${BASENAME}.c    ;\
	fi;\
	if test ${V} ;\
	   then echo "${CC} ${CFLAGS} ${SIMD_CFLAGS} ${PTHREAD_CFLAGS} ${CPPFLAGS} ${DEFS} ${MYINCDIRS} ${LDFLAGS} ${MYLIBDIRS} -D$${DFLAG} -o $@ $${DFILE} ${LIBS}" ;\
	   else echo '    ' GEN $@ ;\
        fi ;\
	${CC} ${CFLAGS} ${SIMD_CFLAGS} ${PTHREAD_CFLAGS} ${CPPFLAGS} ${DEFS} ${MYINCDIRS} ${LDFLAGS} ${MYLIBDIRS} -D$${DFLAG} -o $@ $${DFILE} ${LIBS}

${ALL_UTESTS}: libhmmer.a ${HDRS} h4_config.h
	@BASENAME=`echo $@ | sed -e 's/_utest//' | sed -e 's/^h4_//'` ;\
	DFLAG=`echo $${BASENAME} | sed -e 'y/abcdefghijklmnopqrstuvwxyz/ABCDEFGHIJKLMNOPQRSTUVWXYZ/'`;\
	DFLAG=h4$${DFLAG}_TESTDRIVE ;\
	if test -e ${srcdir}/h4_$${BASENAME}.c; then \
           DFILE=${srcdir}/h4_$${BASENAME}.c ;\
        else \
           DFILE=${srcdir}/$${BASENAME}.c ;\
	fi;\
	if test ${V} ;\
	   then echo "${CC} ${CFLAGS} ${SIMD_CFLAGS} ${PTHREAD_CFLAGS} ${CPPFLAGS} ${DEFS} ${MYINCDIRS} ${LDFLAGS} ${MYLIBDIRS} -D$${DFLAG} -o $@ $${DFILE} ${LIBS}" ;\
	   else echo '    ' GEN $@ ;\
        fi ;\
	${CC} ${CFLAGS} ${SIMD_CFLAGS} ${PTHREAD_CFLAGS} ${CPPFLAGS} ${DEFS} ${MYINCDIRS} ${LDFLAGS} ${MYLIBDIRS} -D$${DFLAG} -o $@ $${DFILE} ${LIBS}

${ALL_EXPERIMENTS}: libhmmer.a ${HDRS} h4_config.h
	@BASENAME=`echo $@ | sed -e 's/_experiment[0-9]*//' | sed -e 's/^h4_//'` ;\
	DFLAG=h4`echo $@ | sed -e 's/^h4_//' | sed -e 'y/abcdefghijklmnopqrstuvwxyz/ABCDEFGHIJKLMNOPQRSTUVWXYZ/'`;\
	if test -e ${srcdir}/h4_$${BASENAME}.c    ;\
	   then DFILE=${srcdir}/h4_$${BASENAME}.c ;\
	   else DFILE=${srcdir}/$${BASENAME}.c    ;\
	fi;\
	if test ${V} ;\
	   then echo "${CC} ${CFLAGS} ${SIMD_CFLAGS} ${PTHREAD_CFLAGS} ${CPPFLAGS} ${DEFS} ${MYINCDIRS} ${LDFLAGS} ${MYLIBDIRS} -D$${DFLAG} -o $@ $${DFILE} ${LIBS}" ;\
	   else echo '    ' GEN $@ ;\
        fi ;\
	${CC} ${CFLAGS} ${SIMD_CFLAGS} ${PTHREAD_CFLAGS} ${CPPFLAGS} ${DEFS} ${MYINCDIRS} ${LDFLAGS} ${MYLIBDIRS} -D$${DFLAG} -o $@ $${DFILE} ${LIBS}

distclean: clean
	-rm -f Makefile h4_config.h

clean:
	-rm -f ${PROGS} ${UTESTS} ${STATS} ${BENCHMARKS} ${EXAMPLES} ${EXPERIMENTS} libhmmer.a
	-rm -f *~ *.o 
	-rm -f *.gcno *.gcda *.gcov
	for prog in ${PROGS} ${UTESTS} ${STATS} ${BENCHMARKS} ${EXAMPLES} ${EXPERIMENTS}; do\
	  if test -d $$prog.dSYM; then rm -rf $$prog.dSYM; fi; \
	done
