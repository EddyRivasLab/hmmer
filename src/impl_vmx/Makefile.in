# HMMER VMX optimized implementation
#
# Michael Farrar
# SVN $Id$

CC             = @CC@
CFLAGS         = @CFLAGS@
SIMDFLAGS      = @SIMD_CFLAGS@
CPPFLAGS       = @CPPFLAGS@
LDFLAGS        = @LDFLAGS@
DEFS           = @DEFS@
LIBS           = @LIBS@ -lm
AR             = @AR@ rcv
RANLIB         = @RANLIB@

SHELL          = /bin/sh
MYLIBS         = -lhmmer -leasel -lm
MYLIBDIRS      = -L../../easel -L..
MYINCDIRS      = -I../../easel -I..

OBJS =  decoding.o\
	fwdback.o\
	io.o\
	msvfilter.o\
	null2.o\
	optacc.o\
	stotrace.o\
	vitfilter.o\
	p7_omx.o\
	p7_oprofile.o

HDRS =  impl_vmx.h

UTESTS = \
	decoding_utest\
	fwdback_utest\
	io_utest\
	msvfilter_utest\
	null2_utest\
	optacc_utest\
	stotrace_utest\
	vitfilter_utest

BENCHMARKS =\
	decoding_benchmark\
	fwdback_benchmark\
	msvfilter_benchmark\
	null2_benchmark\
	optacc_benchmark\
	stotrace_benchmark\
	vitfilter_benchmark

EXAMPLES =\
	fwdback_example\
	io_example\
	msvfilter_example\
	optacc_example\
	p7_oprofile_example\
	stotrace_example\
	vitfilter_example

all: 	 impl_lib

check:     
	cd ../../easel; ${MAKE} easel_lib
	cd ..;          ${MAKE} hmmer_lib
	${MAKE} impl_lib
	${MAKE} impl_utests

dev:     
	cd ../../easel; ${MAKE} easel_lib
	cd ..;          ${MAKE} hmmer_lib
	${MAKE} impl_lib
	${MAKE} impl_utests
	${MAKE} impl_benchmarks
	${MAKE} impl_examples

impl_lib:        impl_lib_stamp
impl_utests:     ${UTESTS}
impl_benchmarks: ${BENCHMARKS}
impl_examples:   ${EXAMPLES}

impl_lib_stamp: ${OBJS}
	$(AR) ../libhmmer.a $?
	$(RANLIB) ../libhmmer.a
	chmod 644 ../libhmmer.a	
	touch $@

${OBJS}:   ${HDRS} ../hmmer.h

.c.o:  
	${CC} ${CFLAGS} ${SIMDFLAGS} ${CPPFLAGS} ${DEFS} ${PTHREAD_CFLAGS} ${MYINCDIRS} -c $<

${UTESTS}: ../libhmmer.a ../../easel/libeasel.a 
	@BASENAME=`echo $@ | sed -e 's/_utest//'| sed -e 's/^p7_//'` ;\
	DFLAG=`echo $${BASENAME} | sed -e 'y/abcdefghijklmnopqrstuvwxyz/ABCDEFGHIJKLMNOPQRSTUVWXYZ/'`;\
	DFLAG=p7$${DFLAG}_TESTDRIVE ;\
	if test -e p7_$${BASENAME}.c; then \
           DFILE=p7_$${BASENAME}.c ;\
        else \
           DFILE=$${BASENAME}.c ;\
	fi;\
	echo ${CC} ${CFLAGS} ${SIMDFLAGS} ${CPPFLAGS} ${LDFLAGS} ${DEFS} ${MYLIBDIRS} ${MYINCDIRS} -D$${DFLAG} -o $@ $${DFILE} ${MYLIBS};\
	${CC} ${CFLAGS} ${SIMDFLAGS} ${CPPFLAGS} ${LDFLAGS} ${DEFS} ${MYLIBDIRS} ${MYINCDIRS} -D$${DFLAG} -o $@ $${DFILE} ${MYLIBS}

${BENCHMARKS}: ../libhmmer.a ../../easel/libeasel.a
	@BASENAME=`echo $@ | sed -e 's/_benchmark//' | sed -e 's/^p7_//'`;\
	DFLAG=`echo $${BASENAME} | sed -e 'y/abcdefghijklmnopqrstuvwxyz/ABCDEFGHIJKLMNOPQRSTUVWXYZ/'`;\
	DFLAG=p7$${DFLAG}_BENCHMARK ;\
	if test -e p7_$${BASENAME}.c; then \
           DFILE=p7_$${BASENAME}.c ;\
        else \
           DFILE=$${BASENAME}.c ;\
	fi;\
	echo ${CC} ${CFLAGS} ${SIMDFLAGS} ${CPPFLAGS} ${LDFLAGS} ${DEFS} ${MYLIBDIRS} ${MYINCDIRS} -D$${DFLAG} -o $@ $${DFILE} ${MYLIBS};\
	${CC} ${CFLAGS} ${SIMDFLAGS} ${CPPFLAGS} ${LDFLAGS} ${DEFS} ${MYLIBDIRS} ${MYINCDIRS} -D$${DFLAG} -o $@ $${DFILE} ${MYLIBS}

${EXAMPLES}: ../libhmmer.a ../../easel/libeasel.a 
	@BASENAME=`echo $@ | sed -e 's/_example//'| sed -e 's/^p7_//'` ;\
	DFLAG=`echo $${BASENAME} | sed -e 'y/abcdefghijklmnopqrstuvwxyz/ABCDEFGHIJKLMNOPQRSTUVWXYZ/'`;\
	DFLAG=p7$${DFLAG}_EXAMPLE ;\
	if test -e p7_$${BASENAME}.c; then \
           DFILE=p7_$${BASENAME}.c ;\
        else \
           DFILE=$${BASENAME}.c ;\
	fi;\
	echo ${CC} ${CFLAGS} ${SIMDFLAGS} ${CPPFLAGS} ${LDFLAGS} ${DEFS} ${MYLIBDIRS} ${MYINCDIRS} -D$${DFLAG} -o $@ $${DFILE} ${MYLIBS};\
	${CC} ${CFLAGS} ${SIMDFLAGS} ${CPPFLAGS} ${LDFLAGS} ${DEFS} ${MYLIBDIRS} ${MYINCDIRS} -D$${DFLAG} -o $@ $${DFILE} ${MYLIBS}

distclean:
	${MAKE} clean
	-rm -f Makefile 

clean:
	-rm -f ${UTESTS}
	-rm -f ${BENCHMARKS}
	-rm -f ${EXAMPLES}
	-rm -f impl_lib_stamp
	-rm -f *.o *~ Makefile.bak core TAGS gmon.out 
	-rm -f *.gcno

binclean:
	-rm -f *.o *~ Makefile.bak core TAGS gmon.out 

tags:
	etags  *.c *.h Makefile.in

###########
# @LICENSE@
###########
