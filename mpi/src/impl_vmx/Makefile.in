# HMMER VMX optimized implementation
#
# SRE, Wed Jul 30 10:49:13 2008 [Janelia]
# SVN $Id$

srcdir     = @srcdir@
top_srcdir = @top_srcdir@
VPATH      = @srcdir@ @top_srcdir@/src

CC             = @CC@
CFLAGS         = @CFLAGS@
SIMDFLAGS      = @SIMD_CFLAGS@
CPPFLAGS       = @CPPFLAGS@
LDFLAGS        = @LDFLAGS@
DEFS           = @DEFS@
LIBS           = @LIBS@ -lm
AR             = @AR@ rcv
RANLIB         = @RANLIB@

ESLDIR         = ../../easel

SHELL          = /bin/sh
MYLIBS         = -Wl,--start-group -lhmmer -lhmmerimpl -Wl,--end-group -leasel -lm
MYLIBDIRS      = -L${ESLDIR} -L.. -L.
MYINCDIRS      = -I${ESLDIR} \
		 -I${top_srcdir}/easel \
		 -I. \
		 -I.. \
		 -I${srcdir} \
		 -I${top_srcdir}/src

OBJS =  decoding.o\
	fwdback.o\
	io.o\
	msvfilter.o\
	null2.o\
	optacc.o\
	stotrace.o\
	vitfilter.o\
	p7_omx.o\
	p7_oprofile.o

HDRS =  impl_vmx.h

UTESTS = \
	decoding_utest\
	fwdback_utest\
	io_utest\
	msvfilter_utest\
	null2_utest\
	optacc_utest\
	stotrace_utest\
	vitfilter_utest

BENCHMARKS =\
	decoding_benchmark\
	fwdback_benchmark\
	msvfilter_benchmark\
	null2_benchmark\
	optacc_benchmark\
	stotrace_benchmark\
	vitfilter_benchmark

EXAMPLES =\
	fwdback_example\
	io_example\
	msvfilter_example\
	optacc_example\
	p7_oprofile_example\
	stotrace_example\
	vitfilter_example

all: 	 impl_lib

check:     
	cd ${ESLDIR};  ${MAKE} easel_lib
	cd ..;         ${MAKE} hmmer_lib
	${MAKE} impl_lib
	${MAKE} impl_utests

dev:     
	cd ${ESLDIR};  ${MAKE} easel_lib
	cd ..;         ${MAKE} hmmer_lib
	${MAKE} impl_lib
	${MAKE} impl_utests
	${MAKE} impl_benchmarks
	${MAKE} impl_examples

impl_lib:        libhmmerimpl.a
impl_utests:     ${UTESTS}
impl_benchmarks: ${BENCHMARKS}
impl_examples:   ${EXAMPLES}

libhmmerimpl.a: ${OBJS}
	$(AR) libhmmerimpl.a $?
	$(RANLIB) libhmmerimpl.a
	chmod 644 libhmmerimpl.a	

${OBJS}:   ${HDRS} ../hmmer.h

.c.o:  
	${CC} ${CFLAGS} ${SIMDFLAGS} ${CPPFLAGS} ${DEFS} ${PTHREAD_CFLAGS} ${MYINCDIRS} -c $<

${UTESTS}: ../libhmmer.a libhmmerimpl.a ${ESLDIR}/libeasel.a 
	@BASENAME=`echo $@ | sed -e 's/_utest//'| sed -e 's/^p7_//'` ;\
	DFLAG=`echo $${BASENAME} | sed -e 'y/abcdefghijklmnopqrstuvwxyz/ABCDEFGHIJKLMNOPQRSTUVWXYZ/'`;\
	DFLAG=p7$${DFLAG}_TESTDRIVE ;\
	if test -e ${srcdir}/p7_$${BASENAME}.c; then \
           DFILE=${srcdir}/p7_$${BASENAME}.c ;\
        else \
           DFILE=${srcdir}/$${BASENAME}.c ;\
	fi;\
	echo ${CC} ${CFLAGS} ${SIMDFLAGS} ${CPPFLAGS} ${LDFLAGS} ${DEFS} ${MYLIBDIRS} ${MYINCDIRS} -D$${DFLAG} -o $@ $${DFILE} ${MYLIBS};\
	${CC} ${CFLAGS} ${SIMDFLAGS} ${CPPFLAGS} ${LDFLAGS} ${DEFS} ${MYLIBDIRS} ${MYINCDIRS} -D$${DFLAG} -o $@ $${DFILE} ${MYLIBS}

${BENCHMARKS}: ../libhmmer.a libhmmerimpl.a ${ESLDIR}/libeasel.a
	@BASENAME=`echo $@ | sed -e 's/_benchmark//' | sed -e 's/^p7_//'`;\
	DFLAG=`echo $${BASENAME} | sed -e 'y/abcdefghijklmnopqrstuvwxyz/ABCDEFGHIJKLMNOPQRSTUVWXYZ/'`;\
	DFLAG=p7$${DFLAG}_BENCHMARK ;\
	if test -e ${srcdir}/p7_$${BASENAME}.c; then \
           DFILE=${srcdir}/p7_$${BASENAME}.c ;\
        else \
           DFILE=${srcdir}/$${BASENAME}.c ;\
	fi;\
	echo ${CC} ${CFLAGS} ${SIMDFLAGS} ${CPPFLAGS} ${LDFLAGS} ${DEFS} ${MYLIBDIRS} ${MYINCDIRS} -D$${DFLAG} -o $@ $${DFILE} ${MYLIBS};\
	${CC} ${CFLAGS} ${SIMDFLAGS} ${CPPFLAGS} ${LDFLAGS} ${DEFS} ${MYLIBDIRS} ${MYINCDIRS} -D$${DFLAG} -o $@ $${DFILE} ${MYLIBS}

${EXAMPLES}: ../libhmmer.a libhmmerimpl.a ${ESLDIR}/libeasel.a 
	@BASENAME=`echo $@ | sed -e 's/_example//'| sed -e 's/^p7_//'` ;\
	DFLAG=`echo $${BASENAME} | sed -e 'y/abcdefghijklmnopqrstuvwxyz/ABCDEFGHIJKLMNOPQRSTUVWXYZ/'`;\
	DFLAG=p7$${DFLAG}_EXAMPLE ;\
	if test -e ${srcdir}/p7_$${BASENAME}.c; then \
           DFILE=${srcdir}/p7_$${BASENAME}.c ;\
        else \
           DFILE=${srcdir}/$${BASENAME}.c ;\
	fi;\
	echo ${CC} ${CFLAGS} ${SIMDFLAGS} ${CPPFLAGS} ${LDFLAGS} ${DEFS} ${MYLIBDIRS} ${MYINCDIRS} -D$${DFLAG} -o $@ $${DFILE} ${MYLIBS};\
	${CC} ${CFLAGS} ${SIMDFLAGS} ${CPPFLAGS} ${LDFLAGS} ${DEFS} ${MYLIBDIRS} ${MYINCDIRS} -D$${DFLAG} -o $@ $${DFILE} ${MYLIBS}

distclean:
	${MAKE} clean
	-rm -f Makefile 

clean:
	-rm -f ${UTESTS}
	-rm -f ${BENCHMARKS}
	-rm -f ${EXAMPLES}
	-rm -f libhmmerimpl.a
	-rm -f *.o *~ Makefile.bak core TAGS gmon.out 
	-rm -f *.gcno

binclean:
	-rm -f *.o *~ Makefile.bak core TAGS gmon.out 

tags:
	etags  *.c *.h Makefile.in

###########
# @LICENSE@
###########
